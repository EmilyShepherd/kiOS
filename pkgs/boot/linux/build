
case "$ARCH" in
  amd64) install_target="install modules_install" ;;
  arm64) install_target="zinstall modules_instlal dtbs_install" ;;
esac
type=make

pre_build() {
  export INSTALL_PATH=${BUILD_DIR}/boot
  export INSTALL_MOD_PATH=${BUILD_DIR}

  mkdir -p $INSTALL_PATH
  rm -rf ${INSTALL_PATH}/*

  if test "${ARCH}" == "amd64"
  then
    export ARCH=x86_64
  fi

  if ! test -f .config
  then
    cp ../config.${ARCH} .config
  fi
}

post_build() {
  mkdir -p ${DATAPART}
  cp -r ${BUILD_DIR}/lib/modules ${DATAPART}/

  case "$ARCH" in
    x86_64)
      mkdir -p ${BOOTPART}/EFI/Boot
      cp ${INSTALL_PATH}/vmlinuz ${BOOTPART}/EFI/Boot/Bootx64.efi
      ;;
    arm64)
      mkdir -p ${BOOTPART}/boot
      cp ${INSTALL_PATH}/vmlinuz* ${BOOTPART}/boot/kernel8.img
      find ${INSTALL_PATH} -name '*.dtb' | xargs -I{} cp {} ${BOOTPART}/boot/
      ;;
  esac
}
