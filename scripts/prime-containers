#!/bin/bash
#
# Pre-downloads images to the given location
#
# This is intended to be used to prime containers within a datapart or
# initramfs so that they can be used before networking is setup.
#
# The images to download can either be given explicitly on the command
# line, or one or more manifest directories can be specified. Any images
# specified in the manifests will be pulled.
#

declare -A images

while ! test -z "$1"
do
  case "$1" in
    "--root" | "-r")
      ROOT="$2"
      shift
      ;;
    "--manifest-dir" | "-m")
      for img in $(grep image: $2/*.yaml | grep -o '\("[^"]\+"\)\|\([^ "]\+$\)' | sed 's/"//g')
      do
        images[$img]="y"
      done
      shift
      ;;
    "--pause" | "-p")
      images["registry.k8s.io/pause:$2"]="y"
      shift
      ;;
    *)
      images[$1]="y"
      ;;
  esac
  shift
done

podman="podman --root ${ROOT}"

$podman pull --platform=linux/amd64 "${!images[@]}"

is_desired() {
  for name in $@
  do
    if test "${images[$name]}" == "y"
    then
      return 0
    fi
  done

  return 1
}

$podman images \
  --format '{{printf "%s\t" .Id}}{{- range $i := .Names}}{{printf "%s\t" $i}}{{- end}}' | \
  while read id names
  do
    if ! is_desired $names
    then
      $podman rmi -f $id;
    fi
  done


cd "${ROOT}"

rm -rf \
  overlay-containers \
  libpod \
  overlay-layers/*.gz \
  volumes \
  defaultNetworkBackend networks \
  *.lock */*.lock db.sql
